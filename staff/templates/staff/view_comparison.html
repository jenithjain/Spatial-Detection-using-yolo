{% extends 'staff/base.html' %}
{% load static %}
{% load staff_extras %}




{% block extra_css %}
<style>
    .comparison-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1.5rem;
    }

    .page-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .page-header h2 {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-color);
        margin-bottom: 0.5rem;
    }

    .status-banner {
        border-radius: 12px;
        padding: 1.25rem;
        margin-bottom: 2rem;
        border: 1px solid rgba(0,0,0,0.1);
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .status-banner.success {
        background-color: rgba(40, 167, 69, 0.1);
        border-left: 4px solid #28a745;
    }

    .status-banner.warning {
        background-color: rgba(255, 193, 7, 0.1);
        border-left: 4px solid #ffc107;
    }

    .image-comparison {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .image-card {
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: 1px solid rgba(0,0,0,0.1);
    }

    .image-card-header {
        padding: 1rem;
        background: #f8f9fa;
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    .image-card-header h3 {
        font-size: 1.1rem;
        margin: 0;
        color: var(--text-color);
    }

    .image-card-body {
        padding: 1rem;
    }

    .image-card img {
        width: 100%;
        height: auto;
        border-radius: 8px;
    }

    .room-details {
        background: #fff;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: 1px solid rgba(0,0,0,0.1);
    }

    .room-details h3 {
        font-size: 1.2rem;
        margin-bottom: 1rem;
        color: var(--text-color);
    }

    .details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .detail-item {
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .detail-item strong {
        display: block;
        font-size: 0.875rem;
        color: rgba(0,0,0,0.6);
        margin-bottom: 0.25rem;
    }

    .detail-item span {
        font-size: 1rem;
        color: var(--text-color);
    }

    .analysis-button {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        background-color: var(--primary-color);
        border: 1px solid var(--text-color);
        border-radius: 8px;
        box-shadow: 2px 2px 0px var(--text-color);
        font-weight: 600;
        text-decoration: none;
        color: var(--text-color);
        transition: all 0.2s ease;
    }

    .analysis-button:hover {
        transform: translate(1px, 1px);
        box-shadow: 1px 1px 0px var(--text-color);
    }

    .status-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .status-card {
        background: #fff;
        border-radius: 12px;
        padding: 1.25rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: 1px solid rgba(0,0,0,0.1);
    }

    .status-card h4 {
        font-size: 1.1rem;
        margin-bottom: 1rem;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .status-card.missing {
        border-left: 4px solid #dc3545;
    }

    .status-card.added {
        border-left: 4px solid #0dcaf0;
    }

    .status-card.shifted {
        border-left: 4px solid #ffc107;
    }

    .item-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .item-list li {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .item-list li:last-child {
        border-bottom: none;
    }

    .inventory-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .inventory-table th {
        background: #f8f9fa;
        padding: 1rem;
        font-weight: 600;
        text-align: left;
        border-bottom: 2px solid rgba(0,0,0,0.1);
    }

    .inventory-table td {
        padding: 1rem;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .inventory-table tr:last-child td {
        border-bottom: none;
    }

    .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .badge.success {
        background-color: rgba(40, 167, 69, 0.1);
        color: #28a745;
    }

    .badge.danger {
        background-color: rgba(220, 53, 69, 0.1);
        color: #dc3545;
    }

    .badge.warning {
        background-color: rgba(255, 193, 7, 0.1);
        color: #ffc107;
    }

    .badge.info {
        background-color: rgba(13, 202, 240, 0.1);
        color: #0dcaf0;
    }

    .mark-as-ok-btn {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        border: 1px solid rgba(0,0,0,0.1);
        background: #fff;
        color: rgba(0,0,0,0.6);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .mark-as-ok-btn:hover {
        background: #f8f9fa;
        border-color: rgba(0,0,0,0.2);
    }

    @media (max-width: 768px) {
        .image-comparison {
            grid-template-columns: 1fr;
        }

        .status-cards {
            grid-template-columns: 1fr;
        }

        .inventory-table {
            font-size: 0.875rem;
        }
    }

    /* Action Buttons */
    .action-buttons {
        padding: 1.5rem;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-top: 2rem;
    }

    .btn-back,
    .btn-report,
    .btn-complete,
    .btn-cancel,
    .btn-report-complete {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.2s ease;
        border: 1px solid;
    }

    .btn-back {
        background-color: #f8f9fa;
        border-color: #dee2e6;
        color: #6c757d;
    }

    .btn-back:hover {
        background-color: #e9ecef;
        color: #495057;
    }

    .btn-report {
        background-color: #dc3545;
        border-color: #dc3545;
        color: #fff;
    }

    .btn-report:hover {
        background-color: #c82333;
        border-color: #bd2130;
    }

    .btn-complete {
        background-color: #28a745;
        border-color: #28a745;
        color: #fff;
    }

    .btn-complete:hover {
        background-color: #218838;
        border-color: #1e7e34;
    }

    /* Modal Styles */
    .modal-content {
        border-radius: 12px;
        border: none;
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }

    .modal-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid rgba(0,0,0,0.1);
        padding: 1.25rem;
    }

    .modal-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1.25rem;
        color: var(--text-color);
    }

    .modal-body {
        padding: 1.5rem;
    }

    .report-section {
        margin-bottom: 1.5rem;
    }

    .section-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1rem;
        margin-bottom: 0.75rem;
        color: var(--text-color);
    }

    .report-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .report-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0.75rem;
        background-color: #f8f9fa;
        border-radius: 6px;
        margin-bottom: 0.5rem;
    }

    .item-name {
        font-weight: 500;
    }

    .item-count {
        background-color: rgba(0,0,0,0.1);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.875rem;
    }

    .modal-footer {
        border-top: 1px solid rgba(0,0,0,0.1);
        padding: 1.25rem;
    }

    .btn-cancel {
        background-color: #f8f9fa;
        border-color: #dee2e6;
        color: #6c757d;
    }

    .btn-cancel:hover {
        background-color: #e9ecef;
        color: #495057;
    }

    .btn-report-complete {
        background-color: #dc3545;
        border-color: #dc3545;
        color: #fff;
    }

    .btn-report-complete:hover {
        background-color: #c82333;
        border-color: #bd2130;
    }

    /* Toast Styles */
    .toast-container {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        z-index: 1050;
    }

    .toast {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border: 1px solid rgba(0,0,0,0.1);
        margin-bottom: 0.5rem;
    }

    .toast-header {
        border-radius: 8px 8px 0 0;
        padding: 0.75rem 1rem;
    }

    .toast-body {
        padding: 0.75rem 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="comparison-container">
    <div class="page-header">
        <h2>Room {{ room_activity.room_number }} Comparison</h2>
        <p class="text-muted">Comparing check-in and check-out state</p>
        </div>

    <div class="status-banner {% if room_activity.has_missing_items %}warning{% else %}success{% endif %}">
        <h4 class="mb-2">
                    {% if room_activity.has_missing_items %}
            <i class="fas fa-exclamation-triangle"></i> Missing Items Detected
                    {% else %}
                    <i class="fas fa-check-circle"></i> All Items Accounted For
                    {% endif %}
        </h4>
                {% if room_activity.has_missing_items %}
        <p class="mb-2">Our system has detected items that were present during check-in but are missing or misplaced during check-out.</p>
                {% else %}
        <p class="mb-2">All items detected during check-in were also detected during check-out. No missing items found.</p>
                {% endif %}
        <small class="text-muted"><i class="fas fa-info-circle"></i> Detection threshold: {{ threshold }} items</small>
            </div>
            
    <div class="image-comparison">
        <div class="image-card">
            <div class="image-card-header">
                <h3>Check-In Image</h3>
                            <small class="text-muted">{{ room_activity.check_in_time }}</small>
                        </div>
            <div class="image-card-body">
                            {% if checkin_detection %}
                <img src="{{ checkin_detection.processed_image.url }}" alt="Check-in Image">
                            {% else %}
                            <div class="alert alert-warning">Check-in image not available</div>
                            {% endif %}
                        </div>
                    </div>

        <div class="image-card">
            <div class="image-card-header">
                <h3>Check-Out Image</h3>
                            <small class="text-muted">{{ room_activity.check_out_time }}</small>
                        </div>
            <div class="image-card-body">
                            {% if checkout_detection %}
                <img src="{{ checkout_detection.processed_image.url }}" alt="Check-out Image">
                            {% else %}
                            <div class="alert alert-warning">Check-out image not available</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

    <div class="room-details">
        <h3>Room Details</h3>
        <div class="details-grid">
            <div class="detail-item">
                <strong>Room Number</strong>
                <span>{{ room_activity.room_number }}</span>
            </div>
            <div class="detail-item">
                <strong>Check-In Time</strong>
                <span>{{ room_activity.check_in_time }}</span>
            </div>
            <div class="detail-item">
                <strong>Check-Out Time</strong>
                <span>{{ room_activity.check_out_time }}</span>
            </div>
                    {% if room_activity.notes %}
            <div class="detail-item">
                <strong>Notes</strong>
                <span>{{ room_activity.notes }}</span>
            </div>
                    {% endif %}
        </div>

        <div class="text-center mt-4">
            <a href="{% url 'staff:detailed_checkout_analysis' room_activity.id %}" class="analysis-button">
                <i class="fas fa-chart-line"></i>
                View Detailed Analysis
            </a>
            <div class="mt-2">
                <small class="text-muted">See multiple analysis methods and visualizations comparing check-in and check-out</small>
            </div>
        </div>
    </div>

    <div class="status-cards">
        <div class="status-card missing">
            <h4><i class="fas fa-times-circle"></i> Missing Items</h4>
                {% if missing_objects %}
            <ul class="item-list">
                    {% for item, count in missing_objects.items %}
                <li><i class="fas fa-minus-circle text-danger"></i> {{ item }}: {{ count }}</li>
                {% endfor %}
            </ul>
            <small class="text-muted mt-2 d-block">Only showing differences exceeding threshold of {{ threshold }}.</small>
            {% else %}
            <p class="mb-0">No items missing or differences within threshold.</p>
            {% endif %}
        </div>

        <div class="status-card added">
            <h4><i class="fas fa-plus-circle"></i> Added Items</h4>
            {% if added_objects %}
            <ul class="item-list">
                {% for item, count in added_objects.items %}
                <li><i class="fas fa-plus-circle text-info"></i> {{ item }}: {{ count }}</li>
                {% endfor %}
            </ul>
            <small class="text-muted mt-2 d-block">Only showing differences exceeding threshold of {{ threshold }}.</small>
            {% else %}
            <p class="mb-0">No new items detected or additions within threshold.</p>
            {% endif %}
        </div>

        <div class="status-card shifted">
            <h4><i class="fas fa-exchange-alt"></i> Shifted Items</h4>
            {% if shifted_objects %}
            <ul class="item-list">
                {% for item, count in shifted_objects.items %}
                <li><i class="fas fa-exchange-alt text-warning"></i> {{ item }}: {{ count }}</li>
                    {% endfor %}
                    </ul>
            {% else %}
            <p class="mb-0">All items remain in their original positions.</p>
            {% endif %}
        </div>
                </div>
                
                <div class="table-responsive">
        <h3 class="mb-3">Item Inventory Comparison</h3>
        <table class="inventory-table">
            <thead>
                            <tr>
                                <th>Object</th>
                                <th>Check-in Count</th>
                                <th>Check-out Count</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                {% for object, count in normalized_checkin_counts.items %}
                <tr>
                    <td><strong>{{ object|title }}</strong></td>
                    <td>{{ count }}</td>
                    {% with checkout_count=normalized_checkout_counts|get_item:object|default:"0" %}
                    <td>{{ checkout_count }}</td>
                    <td>
                        {% if object in approved_items %}
                            <span class="badge success">OK (Approved)</span>
                        {% elif checkout_count < count %}
                            {% with diff=count|subtract:checkout_count %}
                                {% if diff > threshold %}
                                    <span class="badge danger">Missing ({{ diff }})</span>
                                    <form method="post" action="{% url 'staff:mark_item_as_ok' room_activity.id %}" class="d-inline ms-2">
                                        {% csrf_token %}
                                        <input type="hidden" name="item_name" value="{{ object }}">
                                        <button type="submit" class="mark-as-ok-btn" title="Mark as OK">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </form>
                                {% else %}
                                    <span class="badge warning">Minor Diff ({{ diff }})</span>
                                    <form method="post" action="{% url 'staff:mark_item_as_ok' room_activity.id %}" class="d-inline ms-2">
                                        {% csrf_token %}
                                        <input type="hidden" name="item_name" value="{{ object }}">
                                        <button type="submit" class="mark-as-ok-btn" title="Mark as OK">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </form>
                                {% endif %}
                            {% endwith %}
                        {% elif checkout_count > count %}
                            {% with diff=checkout_count|subtract:count %}
                                {% if diff > threshold %}
                                    <span class="badge info">Added ({{ diff }})</span>
                                    <form method="post" action="{% url 'staff:mark_item_as_ok' room_activity.id %}" class="d-inline ms-2">
                                        {% csrf_token %}
                                        <input type="hidden" name="item_name" value="{{ object }}">
                                        <button type="submit" class="mark-as-ok-btn" title="Mark as OK">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </form>
                                {% else %}
                                    <span class="badge warning">Minor Diff ({{ diff }})</span>
                                    <form method="post" action="{% url 'staff:mark_item_as_ok' room_activity.id %}" class="d-inline ms-2">
                                        {% csrf_token %}
                                        <input type="hidden" name="item_name" value="{{ object }}">
                                        <button type="submit" class="mark-as-ok-btn" title="Mark as OK">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </form>
                                {% endif %}
                            {% endwith %}
                        {% else %}
                            <span class="badge success">OK</span>
                        {% endif %}
                    </td>
                    {% endwith %}
                </tr>
                {% endfor %}
                
                {% for object, count in normalized_checkout_counts.items %}
                    {% if object not in normalized_checkin_counts %}
                    <tr>
                        <td><strong>{{ object|title }}</strong></td>
                        <td>0</td>
                                <td>{{ count }}</td>
                        <td>
                            {% if object in approved_items %}
                                <span class="badge success">OK (Approved)</span>
                            {% elif count > threshold %}
                                <span class="badge info">Added ({{ count }})</span>
                                <form method="post" action="{% url 'staff:mark_item_as_ok' room_activity.id %}" class="d-inline ms-2">
                                    {% csrf_token %}
                                    <input type="hidden" name="item_name" value="{{ object }}">
                                    <button type="submit" class="mark-as-ok-btn" title="Mark as OK">
                                        <i class="fas fa-check"></i>
                                    </button>
                                </form>
                                    {% else %}
                                <span class="badge warning">Minor Diff ({{ count }})</span>
                                <form method="post" action="{% url 'staff:mark_item_as_ok' room_activity.id %}" class="d-inline ms-2">
                                    {% csrf_token %}
                                    <input type="hidden" name="item_name" value="{{ object }}">
                                    <button type="submit" class="mark-as-ok-btn" title="Mark as OK">
                                        <i class="fas fa-check"></i>
                                    </button>
                                </form>
                                    {% endif %}
                                </td>
                            </tr>
                    {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
            </div>
            
    <div class="action-buttons mt-4 d-flex justify-content-between align-items-center">
        <a href="{% url 'staff:dashboard' %}" class="btn-back">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
                
                <div>
                    <a href="{% url 'staff:misplaced_items_analysis' activity_id=room_activity.id %}" class="btn btn-primary me-2">
                        <i class="fas fa-exchange-alt"></i> Analyze Misplaced Items
                    </a>
                    
            {% if room_activity.has_missing_items or added_objects or shifted_objects %}
            <button class="btn-report" data-bs-toggle="modal" data-bs-target="#reportModal" id="reportIssuesBtn">
                <i class="fas fa-flag"></i> Report Issues
                </button>
                {% else %}
            <a href="{% url 'staff:dashboard' %}" class="btn-complete" id="completeBtn">
                    <i class="fas fa-check-circle"></i> Complete Check-Out
                </a>
                {% endif %}
        </div>
    </div>
</div>

<!-- Modal for reporting missing items -->
{% if room_activity.has_missing_items or added_objects or shifted_objects %}
<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reportModalLabel">
                    <i class="fas fa-exclamation-triangle text-danger"></i>
                    Report Room Issues
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="reportModalBody">
                {% if missing_objects %}
                <div id="missing-objects-section" class="report-section">
                    <h6 class="section-title">
                        <i class="fas fa-minus-circle text-danger"></i>
                        Missing Items:
                    </h6>
                    <ul id="report-missing-items-list" class="report-list">
                    {% for item, count in missing_objects.items %}
                        <li data-item-name="{{ item }}" class="report-item">
                            <span class="item-name">{{ item }}</span>
                            <span class="item-count">{{ count }}</span>
                        </li>
                    {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                {% if added_objects %}
                <div id="added-objects-section" class="report-section">
                    <h6 class="section-title">
                        <i class="fas fa-plus-circle text-info"></i>
                        Added Items:
                    </h6>
                    <ul id="report-added-items-list" class="report-list">
                    {% for item, count in added_objects.items %}
                        <li data-item-name="{{ item }}" class="report-item">
                            <span class="item-name">{{ item }}</span>
                            <span class="item-count">{{ count }}</span>
                        </li>
                    {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                {% if shifted_objects %}
                <div id="shifted-objects-section" class="report-section">
                    <h6 class="section-title">
                        <i class="fas fa-exchange-alt text-warning"></i>
                        Shifted Items:
                    </h6>
                    <ul id="report-shifted-items-list" class="report-list">
                    {% for item, count in shifted_objects.items %}
                        <li data-item-name="{{ item }}" class="report-item">
                            <span class="item-name">{{ item }}</span>
                            {% if count %}<span class="item-count">{{ count }}</span>{% endif %}
                        </li>
                {% endfor %}
                </ul>
                </div>
                {% endif %}
                
                <div class="alert alert-warning mt-3">
                    <i class="fas fa-info-circle"></i>
                    Would you like to report these issues to management?
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" data-bs-dismiss="modal">Cancel</button>
                <a href="{% url 'staff:dashboard' %}" class="btn-report-complete">
                    <i class="fas fa-paper-plane"></i>
                    Report & Complete Check-Out
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Track issue counts for real-time updates
        let missingItemsCount = {{ missing_objects|length }};
        let addedItemsCount = {{ added_objects|length }};
        let shiftedItemsCount = {{ shifted_objects|length }};
        
        // Function to update report button visibility
        function updateReportButton() {
            const reportBtn = document.getElementById('reportIssuesBtn');
            const completeBtn = document.getElementById('completeBtn');
            const buttonContainer = document.querySelector('.action-buttons');
            
            if (missingItemsCount === 0 && addedItemsCount === 0 && shiftedItemsCount === 0) {
                // No issues to report, show complete button instead
                if (reportBtn) {
                    reportBtn.style.display = 'none';
                }
                
                if (!completeBtn) {
                    // Create complete button if it doesn't exist
                    const newCompleteBtn = document.createElement('a');
                    newCompleteBtn.href = "{% url 'staff:dashboard' %}";
                    newCompleteBtn.className = "btn-complete";
                    newCompleteBtn.id = "completeBtn";
                    newCompleteBtn.innerHTML = '<i class="fas fa-check-circle"></i> Complete Check-Out';
                    buttonContainer.appendChild(newCompleteBtn);
                } else if (completeBtn.style.display === 'none') {
                    completeBtn.style.display = 'block';
                }
            } else {
                // Still have issues, show report button
                if (reportBtn && reportBtn.style.display === 'none') {
                    reportBtn.style.display = 'block';
                }
                if (completeBtn) {
                    completeBtn.style.display = 'none';
                }
            }
        }
        
        // Function to update the modal content
        function updateReportModal(itemName, itemType) {
            // Find and remove the item from appropriate section in the modal
            const modalItemsList = document.querySelector(`#report-${itemType}-items-list`);
            if (modalItemsList) {
                const itemElements = modalItemsList.querySelectorAll(`li[data-item-name="${itemName}"]`);
                itemElements.forEach(element => {
                    element.style.transition = 'all 0.3s ease';
                    element.style.opacity = '0';
                    element.style.transform = 'translateX(-20px)';
                    setTimeout(() => element.remove(), 300);
                });
                
                // If no more items in this category, hide the section
                setTimeout(() => {
                    if (modalItemsList.children.length === 0) {
                        const section = document.getElementById(`${itemType}-objects-section`);
                        if (section) {
                            section.style.transition = 'all 0.3s ease';
                            section.style.opacity = '0';
                            section.style.height = '0';
                            setTimeout(() => section.style.display = 'none', 300);
                        }
                    }
                }, 300);
            }
            
            // Check if modal should be hidden entirely (no more issues)
            if (missingItemsCount === 0 && addedItemsCount === 0 && shiftedItemsCount === 0) {
                const reportModal = document.getElementById('reportModal');
                if (reportModal) {
                    // Hide the modal if it's currently shown
                    const bsModal = bootstrap.Modal.getInstance(reportModal);
                    if (bsModal) {
                        bsModal.hide();
                    }
                }
            }
        }

        // Add click event listeners to all mark as OK buttons
        document.querySelectorAll('.mark-as-ok-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const form = this.closest('form');
                const itemName = form.querySelector('input[name="item_name"]').value;
                const csrfToken = form.querySelector('input[name="csrfmiddlewaretoken"]').value;
                
                // Add loading state
                this.disabled = true;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                
                // Send AJAX request
                fetch(form.action, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrfToken
                    },
                    body: `item_name=${encodeURIComponent(itemName)}`
                })
                .then(response => response.json())
                .then(data => {
                    // Always consider as success if the item was approved
                    if (data.status === 'success' && (data.updated || data.approved)) {
                        // Update issue counts based on response type
                        if (data.type === 'missing') {
                            missingItemsCount = Math.max(0, missingItemsCount - 1);
                            updateReportModal(itemName, 'missing');
                        } else if (data.type === 'added') {
                            addedItemsCount = Math.max(0, addedItemsCount - 1);
                            updateReportModal(itemName, 'added');
                        } else if (data.type === 'shifted') {
                            shiftedItemsCount = Math.max(0, shiftedItemsCount - 1);
                            updateReportModal(itemName, 'shifted');
                        }
                        
                        // Update report/complete button visibility
                        updateReportButton();
                        
                        // Get the closest row or list item
                        const listItem = this.closest('li');
                        const tableRow = this.closest('tr');
                        
                        // Handle list items in the Key Changes section
                        if (listItem) {
                            listItem.style.transition = 'all 0.3s ease';
                            listItem.style.opacity = '0';
                            listItem.style.transform = 'translateX(-20px)';
                            setTimeout(() => {
                                listItem.remove();
                                
                                // Check if there are no more items in the list
                                if (data.type) {
                                    const parentList = document.querySelector(`#${data.type}-items-list`);
                                    if (parentList && parentList.querySelectorAll('li').length === 0) {
                                        // If no more items, hide the section
                                        const section = parentList.closest('.status-card');
                                        if (section) {
                                            section.style.transition = 'all 0.3s ease';
                                            section.style.opacity = '0';
                                            section.style.height = '0';
                                            setTimeout(() => section.style.display = 'none', 300);
                                        }
                                    }
                                }
                            }, 300);
                        }
                        
                        // Handle table rows
                        if (tableRow) {
                            const statusCell = tableRow.querySelector('td:last-child');
                            if (statusCell) {
                                statusCell.innerHTML = '<span class="badge success">OK</span>';
                            }
                        }
                        
                        // Show success toast
                        showToast(`${itemName} marked as OK`, 'success');
                    } else {
                        // Show error toast
                        showToast(`Failed to mark ${itemName} as OK`, 'danger');
                        // Reset button
                        this.disabled = false;
                        this.innerHTML = '<i class="fas fa-check"></i>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast(`Error processing request: ${error.message}`, 'danger');
                    // Reset button
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-check"></i>';
                });
            });
        });
        
        // Initialize Bootstrap modal for report issues
        const reportModal = document.getElementById('reportModal');
        if (reportModal) {
            const bsReportModal = new bootstrap.Modal(reportModal);
        }
        
        // Toast notification function with optional type (success, danger, etc)
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast-container';
            
            toast.innerHTML = `
                <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header bg-${type} text-white">
                        <strong class="me-auto">Status Update</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Add entrance animation
            requestAnimationFrame(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                requestAnimationFrame(() => {
                    toast.style.transition = 'all 0.3s ease';
                    toast.style.opacity = '1';
                    toast.style.transform = 'translateY(0)';
                });
            });
            
            // Remove after 3 seconds with exit animation
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    });
</script>
{% endblock %} 