{% extends 'staff/base.html' %}
{% load static %}
{% load staff_extras %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Room Comparison - Room {{ room_activity.room_number }}</h4>
        </div>
        <div class="card-body">
            <div class="alert {% if room_activity.has_missing_items %}alert-danger{% else %}alert-success{% endif %}">
                <h5 class="alert-heading">
                    {% if room_activity.has_missing_items %}
                    <i class="fas fa-exclamation-triangle"></i> Missing Items Detected!
                    {% else %}
                    <i class="fas fa-check-circle"></i> All Items Accounted For
                    {% endif %}
                </h5>
                
                {% if room_activity.has_missing_items %}
                <p>Our system has detected items that were present during check-in but are missing or misplaced during check-out.</p>
                {% else %}
                <p>All items detected during check-in were also detected during check-out. No missing items found.</p>
                {% endif %}
                <small class="text-muted"><i class="fas fa-info-circle"></i> Note: Our system uses a detection threshold of {{ threshold }} to account for model inaccuracies. Minor differences of {{ threshold }} or fewer items are not flagged as missing or added.</small>
            </div>
            
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Check-In Image</h5>
                            <small class="text-muted">{{ room_activity.check_in_time }}</small>
                        </div>
                        <div class="card-body text-center">
                            {% if checkin_detection %}
                            <img src="{{ checkin_detection.processed_image.url }}" alt="Check-in Image" class="img-fluid rounded">
                            {% else %}
                            <div class="alert alert-warning">Check-in image not available</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Check-Out Image</h5>
                            <small class="text-muted">{{ room_activity.check_out_time }}</small>
                        </div>
                        <div class="card-body text-center">
                            {% if checkout_detection %}
                            <img src="{{ checkout_detection.processed_image.url }}" alt="Check-out Image" class="img-fluid rounded">
                            {% else %}
                            <div class="alert alert-warning">Check-out image not available</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4">
                <h5>
                    Room Details
                </h5>
                <ul class="list-group mb-3">
                    <li class="list-group-item"><strong>Room Number:</strong> {{ room_activity.room_number }}</li>
                    <li class="list-group-item"><strong>Check-In Time:</strong> {{ room_activity.check_in_time }}</li>
                    <li class="list-group-item"><strong>Check-Out Time:</strong> {{ room_activity.check_out_time }}</li>
                    {% if room_activity.notes %}
                    <li class="list-group-item"><strong>Notes:</strong> {{ room_activity.notes }}</li>
                    {% endif %}
                </ul>

                <div class="d-grid gap-2 mb-4">
                    <a href="{% url 'staff:detailed_checkout_analysis' room_activity.id %}" class="btn btn-primary">
                        <i class="fas fa-chart-line"></i> View Detailed Analysis
                    </a>
                    <small class="text-muted text-center">See multiple analysis methods and visualizations comparing check-in and check-out</small>
                </div>

                <div class="row">
                    <!-- Missing Items Section -->
                    <div class="col-md-4">
                        {% if missing_objects %}
                        <div class="alert alert-danger">
                            <h6><strong>Missing Items:</strong></h6>
                            <ul class="list-unstyled mb-0">
                            {% for item, count in missing_objects.items %}
                                <li><i class="fas fa-times-circle text-danger"></i> {{ item }}: {{ count }}</li>
                            {% endfor %}
                            </ul>
                            <small class="text-muted">Only showing differences exceeding threshold of {{ threshold }}.</small>
                        </div>
                        {% else %}
                        <div class="alert alert-success">
                            <h6><strong>No Missing Items</strong></h6>
                            <p class="mb-0">All items from check-in were found at check-out or differences are within acceptable threshold.</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Added Items Section -->
                    <div class="col-md-4">
                        {% if added_objects %}
                        <div class="alert alert-info">
                            <h6><strong>Added Items:</strong></h6>
                            <ul class="list-unstyled mb-0">
                            {% for item, count in added_objects.items %}
                                <li><i class="fas fa-plus-circle text-info"></i> {{ item }}: {{ count }}</li>
                            {% endfor %}
                            </ul>
                            <small class="text-muted">Only showing differences exceeding threshold of {{ threshold }}.</small>
                        </div>
                        {% else %}
                        <div class="alert alert-secondary">
                            <h6><strong>No Added Items</strong></h6>
                            <p class="mb-0">No new items were detected at check-out or additions are within acceptable threshold.</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Shifted Items Section -->
                    <div class="col-md-4">
                        {% if shifted_objects %}
                        <div class="alert alert-warning">
                            <h6><strong>Shifted Items:</strong></h6>
                            <ul class="list-unstyled mb-0">
                            {% for item, count in shifted_objects.items %}
                                <li><i class="fas fa-exchange-alt text-warning"></i> {{ item }}: {{ count }}</li>
                            {% endfor %}
                            </ul>
                        </div>
                        {% else %}
                        <div class="alert alert-secondary">
                            <h6><strong>No Shifted Items</strong></h6>
                            <p class="mb-0">All items remain in their original positions.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <h5 class="mt-4">Item Inventory Comparison (Check-in vs Check-out)</h5>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Object</th>
                                <th>Check-in Count</th>
                                <th>Check-out Count</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for object, count in normalized_checkin_counts.items %}
                            <tr>
                                <td><strong>{{ object|title }}</strong></td>
                                <td>{{ count }}</td>
                                {% with checkout_count=normalized_checkout_counts|get_item:object|default:"0" %}
                                <td>{{ checkout_count }}</td>
                                <td>
                                    {% if object in approved_items %}
                                        <span class="badge bg-success">OK (Approved)</span>
                                    {% elif checkout_count < count %}
                                        {% with diff=count|subtract:checkout_count %}
                                            {% if diff > threshold %}
                                                <span class="badge bg-danger">Missing ({{ diff }})</span>
                                                <form method="post" action="{% url 'staff:mark_item_as_ok' room_activity.id %}" class="d-inline ms-2">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="item_name" value="{{ object }}">
                                                    <button type="submit" class="btn btn-sm btn-outline-secondary mark-as-ok-btn" title="Mark as OK">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                </form>
                                            {% else %}
                                                <span class="badge bg-warning">Minor Diff ({{ diff }})</span>
                                                <form method="post" action="{% url 'staff:mark_item_as_ok' room_activity.id %}" class="d-inline ms-2">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="item_name" value="{{ object }}">
                                                    <button type="submit" class="btn btn-sm btn-outline-secondary mark-as-ok-btn" title="Mark as OK">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                </form>
                                            {% endif %}
                                        {% endwith %}
                                    {% elif checkout_count > count %}
                                        {% with diff=checkout_count|subtract:count %}
                                            {% if diff > threshold %}
                                                <span class="badge bg-info">Added ({{ diff }})</span>
                                                <form method="post" action="{% url 'staff:mark_item_as_ok' room_activity.id %}" class="d-inline ms-2">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="item_name" value="{{ object }}">
                                                    <button type="submit" class="btn btn-sm btn-outline-secondary mark-as-ok-btn" title="Mark as OK">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                </form>
                                            {% else %}
                                                <span class="badge bg-warning">Minor Diff ({{ diff }})</span>
                                                <form method="post" action="{% url 'staff:mark_item_as_ok' room_activity.id %}" class="d-inline ms-2">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="item_name" value="{{ object }}">
                                                    <button type="submit" class="btn btn-sm btn-outline-secondary mark-as-ok-btn" title="Mark as OK">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                </form>
                                            {% endif %}
                                        {% endwith %}
                                    {% else %}
                                        <span class="badge bg-success">OK</span>
                                    {% endif %}
                                </td>
                                {% endwith %}
                            </tr>
                            {% endfor %}
                            
                            {% for object, count in normalized_checkout_counts.items %}
                                {% if object not in normalized_checkin_counts %}
                                <tr>
                                    <td><strong>{{ object|title }}</strong></td>
                                    <td>0</td>
                                    <td>{{ count }}</td>
                                    <td>
                                        {% if object in approved_items %}
                                            <span class="badge bg-success">OK (Approved)</span>
                                        {% elif count > threshold %}
                                            <span class="badge bg-info">Added ({{ count }})</span>
                                            <form method="post" action="{% url 'staff:mark_item_as_ok' room_activity.id %}" class="d-inline ms-2">
                                                {% csrf_token %}
                                                <input type="hidden" name="item_name" value="{{ object }}">
                                                <button type="submit" class="btn btn-sm btn-outline-secondary mark-as-ok-btn" title="Mark as OK">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                            </form>
                                        {% else %}
                                            <span class="badge bg-warning">Minor Diff ({{ count }})</span>
                                            <form method="post" action="{% url 'staff:mark_item_as_ok' room_activity.id %}" class="d-inline ms-2">
                                                {% csrf_token %}
                                                <input type="hidden" name="item_name" value="{{ object }}">
                                                <button type="submit" class="btn btn-sm btn-outline-secondary mark-as-ok-btn" title="Mark as OK">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                            </form>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="alert alert-secondary mt-3">
                    <small><i class="fas fa-info-circle"></i> <strong>Detection Threshold:</strong> Our system uses a threshold of {{ threshold }} to account for potential model inaccuracies. Differences of {{ threshold }} or fewer items are marked as "Minor Diff" rather than "Missing" or "Added".</small>
                </div>
                
                {% if missing_objects or added_objects %}
                <div class="mt-4">
                    <h5>Key Changes Detected</h5>
                    <div class="row">
                        {% if missing_objects %}
                        <div class="col-md-6">
                            <div class="card border-danger mb-3">
                                <div class="card-header bg-danger text-white">
                                    <i class="fas fa-minus-circle"></i> Items Missing from Room
                                </div>
                                <div class="card-body">
                                    <ul class="list-group" id="missing-items-list">
                                    {% for item, count in missing_objects.items %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>{{ item|title }}</span>
                                            <div>
                                                <span class="badge bg-danger rounded-pill">{{ count }}</span>
                                                <form method="post" action="{% url 'staff:mark_item_as_ok' room_activity.id %}" class="d-inline ms-2">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="item_name" value="{{ item }}">
                                                    <button type="submit" class="btn btn-sm btn-outline-secondary mark-as-ok-btn" title="Mark as OK">
                                                        <i class="fas fa-check"></i> Mark as OK
                                                    </button>
                                                </form>
                                            </div>
                                        </li>
                                    {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if added_objects %}
                        <div class="col-md-6">
                            <div class="card border-info mb-3">
                                <div class="card-header bg-info text-white">
                                    <i class="fas fa-plus-circle"></i> Items Added to Room
                                </div>
                                <div class="card-body">
                                    <ul class="list-group" id="added-items-list">
                                    {% for item, count in added_objects.items %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>{{ item|title }}</span>
                                            <div>
                                                <span class="badge bg-info rounded-pill">{{ count }}</span>
                                                <form method="post" action="{% url 'staff:mark_item_as_ok' room_activity.id %}" class="d-inline ms-2">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="item_name" value="{{ item }}">
                                                    <button type="submit" class="btn btn-sm btn-outline-secondary mark-as-ok-btn" title="Mark as OK">
                                                        <i class="fas fa-check"></i> Mark as OK
                                                    </button>
                                                </form>
                                            </div>
                                        </li>
                                    {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
            
            <div class="d-flex justify-content-between mt-4">
                <a href="{% url 'staff:dashboard' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
                
                {% if room_activity.has_missing_items or added_objects or shifted_objects %}
                <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#reportModal" id="reportIssuesBtn">
                    <i class="fas fa-flag"></i> Report Issues
                </button>
                {% else %}
                <a href="{% url 'staff:dashboard' %}" class="btn btn-success" id="completeBtn">
                    <i class="fas fa-check-circle"></i> Complete Check-Out
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal for reporting missing items -->
{% if room_activity.has_missing_items or added_objects or shifted_objects %}
<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="reportModalLabel">Report Room Issues</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="reportModalBody">
                {% if missing_objects %}
                <div id="missing-objects-section">
                    <h6>Missing Items:</h6>
                    <ul id="report-missing-items-list">
                    {% for item, count in missing_objects.items %}
                        <li data-item-name="{{ item }}">{{ item }}: {{ count }}</li>
                    {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                {% if added_objects %}
                <div id="added-objects-section">
                    <h6>Added Items:</h6>
                    <ul id="report-added-items-list">
                    {% for item, count in added_objects.items %}
                        <li data-item-name="{{ item }}">{{ item }}: {{ count }}</li>
                    {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                {% if shifted_objects %}
                <div id="shifted-objects-section">
                    <h6>Shifted Items:</h6>
                    <ul id="report-shifted-items-list">
                    {% for item, count in shifted_objects.items %}
                        <li data-item-name="{{ item }}">{{ item }}</li>
                    {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                <p>Would you like to report these issues to management?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <a href="{% url 'staff:dashboard' %}" class="btn btn-danger">Report & Complete Check-Out</a>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Track issue counts for real-time updates
        let missingItemsCount = {{ missing_objects|length }};
        let addedItemsCount = {{ added_objects|length }};
        let shiftedItemsCount = {{ shifted_objects|length }};
        
        // Function to update report button visibility
        function updateReportButton() {
            const reportBtn = document.getElementById('reportIssuesBtn');
            const completeBtn = document.getElementById('completeBtn');
            const buttonContainer = document.querySelector('.d-flex.justify-content-between.mt-4');
            
            if (missingItemsCount === 0 && addedItemsCount === 0 && shiftedItemsCount === 0) {
                // No issues to report, show complete button instead
                if (reportBtn) {
                    reportBtn.style.display = 'none';
                }
                
                if (!completeBtn) {
                    // Create complete button if it doesn't exist
                    const newCompleteBtn = document.createElement('a');
                    newCompleteBtn.href = "{% url 'staff:dashboard' %}";
                    newCompleteBtn.className = "btn btn-success";
                    newCompleteBtn.id = "completeBtn";
                    newCompleteBtn.innerHTML = '<i class="fas fa-check-circle"></i> Complete Check-Out';
                    buttonContainer.appendChild(newCompleteBtn);
                } else if (completeBtn.style.display === 'none') {
                    completeBtn.style.display = 'block';
                }
            } else {
                // Still have issues, show report button
                if (reportBtn && reportBtn.style.display === 'none') {
                    reportBtn.style.display = 'block';
                }
                if (completeBtn) {
                    completeBtn.style.display = 'none';
                }
            }
        }
        
        // Function to update the modal content
        function updateReportModal(itemName, itemType) {
            // Find and remove the item from appropriate section in the modal
            const modalItemsList = document.querySelector(`#report-${itemType}-items-list`);
            if (modalItemsList) {
                const itemElements = modalItemsList.querySelectorAll(`li[data-item-name="${itemName}"]`);
                itemElements.forEach(element => element.remove());
                
                // If no more items in this category, hide the section
                if (modalItemsList.children.length === 0) {
                    const section = document.getElementById(`${itemType}-objects-section`);
                    if (section) {
                        section.style.display = 'none';
                    }
                }
            }
            
            // Check if modal should be hidden entirely (no more issues)
            if (missingItemsCount === 0 && addedItemsCount === 0 && shiftedItemsCount === 0) {
                const reportModal = document.getElementById('reportModal');
                if (reportModal) {
                    // Hide the modal if it's currently shown
                    const bsModal = bootstrap.Modal.getInstance(reportModal);
                    if (bsModal) {
                        bsModal.hide();
                    }
                }
            }
        }

        // Add click event listeners to all mark as OK buttons
        document.querySelectorAll('.mark-as-ok-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const form = this.closest('form');
                const itemName = form.querySelector('input[name="item_name"]').value;
                const csrfToken = form.querySelector('input[name="csrfmiddlewaretoken"]').value;
                
                console.log('Button clicked', itemName);
                
                // Send AJAX request
                fetch(form.action, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrfToken
                    },
                    body: `item_name=${encodeURIComponent(itemName)}`
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Response data:', data);
                    
                    // Always consider as success if the item was approved
                    if (data.status === 'success' && (data.updated || data.approved)) {
                        // Update issue counts based on response type
                        if (data.type === 'missing') {
                            missingItemsCount = Math.max(0, missingItemsCount - 1);
                            updateReportModal(itemName, 'missing');
                        } else if (data.type === 'added') {
                            addedItemsCount = Math.max(0, addedItemsCount - 1);
                            updateReportModal(itemName, 'added');
                        } else if (data.type === 'shifted') {
                            shiftedItemsCount = Math.max(0, shiftedItemsCount - 1);
                            updateReportModal(itemName, 'shifted');
                        }
                        
                        // Update report/complete button visibility
                        updateReportButton();
                        
                        // Get the closest row or list item
                        const listItem = this.closest('li');
                        const tableRow = this.closest('tr');
                        
                        // Handle list items in the Key Changes section
                        if (listItem) {
                            // Fade out and remove
                            listItem.style.transition = 'opacity 0.3s';
                            listItem.style.opacity = '0';
                            setTimeout(() => {
                                listItem.remove();
                                
                                // Check if there are no more items in the list
                                if (data.type) {
                                    const parentList = document.querySelector(`#${data.type}-items-list`);
                                    if (parentList && parentList.querySelectorAll('li').length === 0) {
                                        // If no more items, hide the section
                                        const section = parentList.closest('.card');
                                        if (section) {
                                            section.style.display = 'none';
                                        }
                                    }
                                }
                            }, 300);
                        }
                        
                        // Handle table rows
                        if (tableRow) {
                            // Update the status cell
                            const statusCell = tableRow.querySelector('td:last-child');
                            if (statusCell) {
                                statusCell.innerHTML = '<span class="badge bg-success">OK</span>';
                            }
                        }
                        
                        // Show a toast notification
                        showToast(`${itemName} marked as OK`);
                    } else {
                        console.error('Failed to update item status', data);
                        showToast(`Failed to mark ${itemName} as OK`, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast(`Error processing request: ${error.message}`, 'danger');
                });
            });
        });
        
        // Initialize Bootstrap modal for report issues
        const reportModal = document.getElementById('reportModal');
        if (reportModal) {
            const bsReportModal = new bootstrap.Modal(reportModal);
        }
        
        // Toast notification function with optional type (success, danger, etc)
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'position-fixed bottom-0 end-0 p-3 toast-container';
            toast.style.zIndex = '5';
            
            toast.innerHTML = `
                <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header bg-${type} text-white">
                        <strong class="me-auto">Status Update</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    });
</script>
{% endblock %} 